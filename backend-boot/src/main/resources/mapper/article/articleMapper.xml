<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "../../../dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.com.qingqfeng.archer.dao.article.IArticleDao" >
    <resultMap id="CountResultMap" type="cn.com.qingqfeng.archer.pojo.article.ArticleDO" >
        <id column="id" property="id" jdbcType="VARCHAR" />
        <result column="title" property="title" jdbcType="VARCHAR" />
        <result column="publish_time" property="publishTime" jdbcType="TIMESTAMP" />
        <result column="image" property="image" jdbcType="VARCHAR" />
        <result column="user" property="userId" jdbcType="VARCHAR" />
        <result column="profile" property="profile" jdbcType="VARCHAR" />
        <result column="visit_count" property="visitCount" jdbcType="INTEGER" />
        <result column="comme_count" property="commentCount" jdbcType="INTEGER" />
        <result column="like_count" property="likeCount" jdbcType="INTEGER" />
    </resultMap>
    <resultMap id="DetailResultMap" type="cn.com.qingqfeng.archer.pojo.article.ArticleDO" >
        <id column="id" property="id" jdbcType="VARCHAR" />
        <result column="title" property="title" jdbcType="VARCHAR" />
        <result column="publish_time" property="publishTime" jdbcType="TIMESTAMP" />
        <result column="front_content" property="frontContent" jdbcType="LONGTEXT" />
        <result column="backend_content" property="backendContent" jdbcType="LONGTEXT" />
        <result column="image" property="image" jdbcType="VARCHAR" />
        <result column="user" property="userId" jdbcType="VARCHAR" />
        <result column="edition" property="edition" jdbcType="VARCHAR"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
        <result column="modify_time" property="modifyTime" jdbcType="TIMESTAMP" />
    </resultMap>    
    
    <select id="queryArticleByOptions" parameterType="cn.com.qingqfeng.archer.pojo.article.ArticleQuery" resultMap="CountResultMap"  >
       SELECT 
            a.id, a.title, a.publish_time, a.image, a.profile, b.nickname as user, c.visit_count, d.comme_count, e.like_count 
       FROM 
            qfeng_article a 
       LEFT JOIN 
            qfeng_user b ON a.user=b.id
       LEFT JOIN
            (select article_id, count(1) as visit_count from qfeng_visit_cord group by article_id) c ON a.id=c.article_id
       LEFT JOIN
            (select article_id, count(1) as comme_count from qfeng_comment group by article_id) d ON a.id = d.article_id
       LEFT JOIN
            (select article_id, count(1) as like_count from qfeng_like group by article_id) e ON a.id = e.article_id
       <choose>
            <when test="tagId!=null and tagId!=''">
            RIGHT JOIN (select article_id from qfeng_tag where tag_id = #{tagId}) f on a.id = f.article_id
            </when>
       </choose>
       WHERE a.publish = 1 limit #{pageSize} offset #{pageSize}*(#{page}-1)
    </select>

    <select id="queryArticleById" parameterType="java.lang.String" resultMap="DetailResultMap" >
        SELECT 
            a.id, a.title, a.publish_time, a.front_content, a.backend_content, a.image, b.nickname as user, a.edition, a.create_time, a.modify_time
       FROM 
            qfeng_article a 
       LEFT JOIN 
            qfeng_user b ON a.user=b.id
       WHERE id = #{id}
    </select>
</mapper>
